<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Invaders</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: monospace;
            position: relative;
        }

        canvas {
            background-color: black;
            display: block;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            border: 2px solid rgba(0, 255, 0, 0.5);
        }

        #controls {
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin-top: 10px;
        }

        #movement-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background-color: #333;
            color: #00FF00;
            border: 2px solid #00FF00;
            padding: 15px 30px;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            border-radius: 5px;
        }

        .control-btn:active {
            background-color: #00FF00;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
        }

        #fire-btn {
            width: 120px;
            height: 60px;
        }

        #instructions {
            color: #00FF00;
            font-family: monospace;
            font-size: 16px;
            margin-top: 15px;
            text-align: center;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        @media (max-width: 800px) {
            canvas {
                width: 100%;
                height: auto;
            }
            
            #controls {
                width: 100%;
                padding: 0 10px;
                box-sizing: border-box;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls">
        <div id="movement-controls">
            <div id="left-btn" class="control-btn">&#8592;</div>
            <div id="right-btn" class="control-btn">&#8594;</div>
        </div>
        <div id="fire-btn" class="control-btn">FIRE</div>
    </div>
    
    <div id="instructions">
        Tastiera: Frecce ← → per muovere, Spazio per sparare
    </div>
    
    <script>
        // game.js
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // Imposta dimensioni fisse in stile retrò
        canvas.width = 800;
        canvas.height = 600;

        let player, invaders = [], bullets = [], playerBullets = [], alienBullets = [];
        let score = 0;
        let lives = 3;
        let gameOver = false;
        let level = 1;
        let animationFrame = 0;
        let animationCounter = 0;
        let ufo = null;
        let explosions = [];
        let stars = [];
        
        // Sprite per gli elementi del gioco con maggiore definizione
        const sprites = {
            player: [
                "    ######    ",
                "   ########   ",
                "  ##########  ",
                " ############ ",
                " ############## ",
                "################",
                "##################",
                "##################"
            ],
            // Ogni tipo di alieno ha due frame di animazione con maggiore definizione
            invader1: [
                [
                    "    ####    ",
                    "   ######   ",
                    "  ########  ",
                    " ## #### ## ",
                    "############",
                    "# ######## #",
                    "# #      # #",
                    "   ##  ##   "
                ],
                [
                    "    ####    ",
                    "   ######   ",
                    "  ########  ",
                    " ## #### ## ",
                    "############",
                    "# ######## #",
                    "   #    #   ",
                    "  ##    ##  "
                ]
            ],
            invader2: [
                [
                    "   ##     ##   ",
                    "    ##   ##    ",
                    "   #########   ",
                    "  ###########  ",
                    " ##### ##### ",
                    "############",
                    "# ##    ## #",
                    "#          #"
                ],
                [
                    "   ##     ##   ",
                    "    ##   ##    ",
                    "   #########   ",
                    "  ###########  ",
                    " ##### ##### ",
                    "############",
                    "  ##    ##  ",
                    " #        # "
                ]
            ],
            invader3: [
                [
                    "     ####     ",
                    "    ######    ",
                    "   ########   ",
                    "  ##  ##  ##  ",
                    " ########### ",
                    "##############",
                    "# ##      ## #",
                    "#  ##    ##  #"
                ],
                [
                    "     ####     ",
                    "    ######    ",
                    "   ########   ",
                    "  ##  ##  ##  ",
                    " ########### ",
                    "##############",
                    " #  ####  # ",
                    "#  #    #  #"
                ]
            ],
            ufo: [
                "     ########     ",
                "   ############   ",
                "  ##############  ",
                " ###### ###### ",
                "##################",
                "   # ######## #   ",
                "    #        #    "
            ],
            explosion: [
                "#    #    #",
                " #   #   # ",
                "  #  #  #  ",
                "   # # #   ",
                "    ###    ",
                "   # # #   ",
                "  #  #  #  ",
                " #   #   # ",
                "#    #    #"
            ],
            barrier: [
                "    ########    ",
                "   ##########   ",
                "  ############  ",
                " ############## ",
                "################",
                "################",
                "##### ###### ###",
                "####  ####  ####",
                "###    ##    ###"
            ]
        };

        // Crea stelle per lo sfondo
        function createStars() {
            for (let i = 0; i < 100; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    brightness: Math.random()
                });
            }
        }

        // Disegna le stelle
        function drawStars() {
            stars.forEach(star => {
                ctx.fillStyle = `rgba(255, 255, 255, ${0.3 + 0.7 * star.brightness})`;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });
        }

        // Funzione per disegnare sprite pixel per pixel con maggiore definizione
        function drawSprite(sprite, x, y, scale, color) {
            ctx.fillStyle = color || 'white';
            for (let row = 0; row < sprite.length; row++) {
                for (let col = 0; col < sprite[row].length; col++) {
                    if (sprite[row][col] === '#') {
                        ctx.fillRect(x + col * scale, y + row * scale, scale, scale);
                    }
                }
            }
        }

        // Classe per il giocatore
        class Player {
            constructor() {
                this.width = 16 * 2; // 16px × 2 scale
                this.height = 8 * 2; // 8px × 2 scale
                this.x = canvas.width / 2 - this.width / 2;
                this.y = canvas.height - 50;
                this.speed = 5;
                this.movingLeft = false;
                this.movingRight = false;
                this.shootCooldown = 0;
                this.scale = 2;
            }

            draw() {
                drawSprite(sprites.player, this.x, this.y, this.scale, '#00FF00');
            }

            shoot() {
                if (this.shootCooldown <= 0) {
                    playerBullets.push(new Bullet(this.x + this.width / 2 - 1, this.y, -10, 'white'));
                    this.shootCooldown = 15; // Cooldown più breve
                    
                    // Effetto sonoro di sparo (simulato con vibrazione su dispositivi mobili)
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }
            }

            update() {
                if (this.shootCooldown > 0) this.shootCooldown--;
                
                if (this.movingLeft) this.x -= this.speed;
                if (this.movingRight) this.x += this.speed;
                
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
            }
        }

        // Classe per gli invasori con maggiore definizione
        class Invader {
            constructor(x, y, type) {
                this.width = 16 * 2; // 16px × 2 scale
                this.height = 8 * 2; // 8px × 2 scale
                this.x = x;
                this.y = y;
                this.type = type || Math.floor(Math.random() * 3);
                this.speed = 0.5 + level * 0.1;
                this.direction = 1;
                this.scale = 2;
                this.shootChance = 0.001 + (level * 0.0005);
            }

            draw() {
                let sprite;
                let color;
                
                // Seleziona lo sprite in base al tipo e al frame di animazione
                if (this.type === 0) {
                    sprite = sprites.invader1[animationFrame];
                    color = 'white'; // Alieno tipo 1: bianco
                } else if (this.type === 1) {
                    sprite = sprites.invader2[animationFrame];
                    color = 'white'; // Alieno tipo 2: bianco
                } else {
                    sprite = sprites.invader3[animationFrame];
                    color = 'white'; // Alieno tipo 3: bianco
                }
                
                drawSprite(sprite, this.x, this.y, this.scale, color);
            }

            update() {
                this.x += this.speed * this.direction;
                
                // Possibilità casuale di sparare
                if (Math.random() < this.shootChance) {
                    this.shoot();
                }
            }

            shoot() {
                alienBullets.push(new Bullet(this.x + this.width / 2, this.y + this.height, 3, 'white'));
            }
        }

        // Classe per l'UFO bonus
        class Ufo {
            constructor() {
                this.width = 16 * 2;
                this.height = 7 * 2;
                this.x = -this.width;
                this.y = 30;
                this.speed = 2;
                this.scale = 2;
                this.active = true;
                this.points = Math.floor(Math.random() * 3 + 1) * 50; // 50, 100, o 150 punti
            }

            draw() {
                drawSprite(sprites.ufo, this.x, this.y, this.scale, '#FF0000'); // UFO rosso
            }

            update() {
                this.x += this.speed;
                
                if (this.x > canvas.width) {
                    this.active = false;
                }
            }
        }

        // Classe per effetti di esplosione
        class Explosion {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.scale = 2;
                this.frame = 0;
                this.maxFrames = 20;
                this.color = color || 'white';
            }

            draw() {
                const alpha = 1 - (this.frame / this.maxFrames);
                ctx.globalAlpha = alpha;
                drawSprite(sprites.explosion, this.x, this.y, this.scale, this.color);
                ctx.globalAlpha = 1.0;
            }

            update() {
                this.frame++;
                return this.frame < this.maxFrames;
            }
        }

        // Classe per i proiettili migliorati
        class Bullet {
            constructor(x, y, speed, color) {
                this.width = 2;
                this.height = 10;
                this.x = x - this.width / 2;
                this.y = y;
                this.speed = speed;
                this.color = color || '#FFFFFF';
            }

            draw() {
                ctx.fillStyle = this.color;
                
                // Disegna un proiettile più elegante (come una piccola scia)
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillRect(this.x - 1, this.y + 3, this.width + 2, this.height - 6); // Parte centrale più larga
            }

            update() {
                this.y += this.speed;
                
                // Aggiungi un leggero movimento casuale per un effetto più dinamico
                this.x += Math.random() * 0.6 - 0.3;
            }
        }

        // Classe per le barriere con maggiore definizione
        class Barrier {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 16 * 3;
                this.height = 9 * 3;
                this.scale = 3;
                this.health = 4;
                this.maxHealth = 4;
                // Mappa dei danni per la barriera
                this.damageMap = Array(9).fill().map(() => Array(16).fill(false));
            }

            draw() {
                // Disegna la barriera con il colore che varia in base alla salute
                const healthPercent = this.health / this.maxHealth;
                let color;
                
                if (healthPercent > 0.7) color = '#00FF00';  // Verde per barriera intatta
                else if (healthPercent > 0.3) color = '#CCFF00';  // Giallo-verde per barriera danneggiata
                else color = '#FF6600';  // Arancione per barriera molto danneggiata
                
                drawSprite(sprites.barrier, this.x, this.y, this.scale, color);
                
                // Disegna i danni
                ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                for (let row = 0; row < this.damageMap.length; row++) {
                    for (let col = 0; col < this.damageMap[row].length; col++) {
                        if (this.damageMap[row][col]) {
                            ctx.fillRect(this.x + col * this.scale, this.y + row * this.scale, this.scale, this.scale);
                        }
                    }
                }
            }

            addDamage(hitX, hitY) {
                // Calcola la posizione relativa del colpo sulla barriera
                const relX = Math.floor((hitX - this.x) / this.scale);
                const relY = Math.floor((hitY - this.y) / this.scale);
                
                // Verifica se la posizione è all'interno della barriera
                if (relX >= 0 && relX < 16 && relY >= 0 && relY < 9) {
                    // Aggiungi danni in un pattern 3x3 intorno al punto di impatto
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const nx = relX + dx;
                            const ny = relY + dy;
                            if (nx >= 0 && nx < 16 && ny >= 0 && ny < 9 && Math.random() > 0.3) {
                                this.damageMap[ny][nx] = true;
                            }
                        }
                    }
                    
                    // Riduci la salute
                    this.health -= 0.2;
                    if (this.health <= 0) return true; // La barriera è distrutta
                }
                return false;
            }
        }

        // Funzione per generare l'UFO occasionalmente
        function maybeSpawnUfo() {
            if (!ufo && Math.random() < 0.002) {
                ufo = new Ufo();
            }
        }

        // Generazione degli invasori
        function spawnInvaders() {
            const rows = 5;
            const cols = 11;
            const spacing = 50;
            const startX = (canvas.width - cols * spacing) / 2;
            
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    // Tipo di invasore in base alla riga
                    let type = 0;
                    if (i < 1) type = 0;      // Prima riga: tipo 1
                    else if (i < 3) type = 1;  // Seconda e terza riga: tipo 2
                    else type = 2;             // Altre righe: tipo 3
                    
                    invaders.push(new Invader(startX + j * spacing, 50 + i * spacing, type));
                }
            }
        }

        // Generazione delle barriere
        let barriers = [];
        function createBarriers() {
            barriers = [];
            const count = 4;
            const spacing = canvas.width / (count + 1);
            
            for (let i = 0; i < count; i++) {
                barriers.push(new Barrier(spacing * (i + 1) - 24, canvas.height - 150));
            }
        }

        // Gestione della logica di gioco
        function init() {
            player = new Player();
            invaders = [];
            playerBullets = [];
            alienBullets = [];
            explosions = [];
            spawnInvaders();
            createBarriers();
            createStars();
            
            // Aggiungi controlli dei pulsanti
            setupControlButtons();
            
            // Controlli da tastiera
            document.addEventListener("keydown", (e) => {
                if (e.key === "ArrowLeft") player.movingLeft = true;
                if (e.key === "ArrowRight") player.movingRight = true;
                if (e.key === " ") player.shoot();
            });

            document.addEventListener("keyup", (e) => {
                if (e.key === "ArrowLeft") player.movingLeft = false;
                if (e.key === "ArrowRight") player.movingRight = false;
            });
            
            gameLoop();
        }
        
        // Configurazione dei pulsanti di controllo
        function setupControlButtons() {
            const leftBtn = document.getElementById("left-btn");
            const rightBtn = document.getElementById("right-btn");
            const fireBtn = document.getElementById("fire-btn");
            
            // Pulsante sinistra
            leftBtn.addEventListener("mousedown", () => player.movingLeft = true);
            leftBtn.addEventListener("mouseup", () => player.movingLeft = false);
            leftBtn.addEventListener("mouseleave", () => player.movingLeft = false);
            leftBtn.addEventListener("touchstart", (e) => {
                e.preventDefault();
                player.movingLeft = true;
            });
            leftBtn.addEventListener("touchend", () => player.movingLeft = false);
            
            // Pulsante destra
            rightBtn.addEventListener("mousedown", () => player.movingRight = true);
            rightBtn.addEventListener("mouseup", () => player.movingRight = false);
            rightBtn.addEventListener("mouseleave", () => player.movingRight = false);
            rightBtn.addEventListener("touchstart", (e) => {
                e.preventDefault();
                player.movingRight = true;
            });
            rightBtn.addEventListener("touchend", () => player.movingRight = false);
            
            // Pulsante fuoco
            fireBtn.addEventListener("mousedown", () => player.shoot());
            fireBtn.addEventListener("touchstart", (e) => {
                e.preventDefault();
                player.shoot();
            });
        }

        // Loop principale del gioco
        function gameLoop() {
            if (gameOver) {
                showGameOver();
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Disegna le stelle di sfondo
            drawStars();
            
            // Gestione dell'animazione degli alieni
            animationCounter++;
            if (animationCounter >= 30) {  // Cambia frame ogni 30 cicli
                animationFrame = 1 - animationFrame;  // Alterna tra 0 e 1
                animationCounter = 0;
            }
            
            // Possibilità di generare un UFO
            maybeSpawnUfo();
            
            // Aggiorna e disegna l'UFO se presente
            if (ufo) {
                ufo.update();
                if (ufo.active) {
                    ufo.draw();
                } else {
                    ufo = null;
                }
            }
            
            // Aggiorna e disegna il giocatore
            player.update();
            player.draw();
            
            // Aggiorna e disegna i proiettili del giocatore
            for (let i = playerBullets.length - 1; i >= 0; i--) {
                playerBullets[i].update();
                playerBullets[i].draw();
                
                // Rimuovi i proiettili fuori dallo schermo
                if (playerBullets[i].y < 0) {
                    playerBullets.splice(i, 1);
                    continue;
                }
            }
            
            // Aggiorna e disegna i proiettili alieni
            for (let i = alienBullets.length - 1; i >= 0; i--) {
                alienBullets[i].update();
                alienBullets[i].draw();
                
                // Rimuovi i proiettili fuori dallo schermo
                if (alienBullets[i].y > canvas.height) {
                    alienBullets.splice(i, 1);
                    continue;
                }
            }
            
            // Aggiorna la posizione degli invasori
            let moveDown = false;
            invaders.forEach(invader => {
                if (invader.x <= 0 || invader.x + invader.width >= canvas.width) {
                    moveDown = true;
                }
            });
            
            if (moveDown) {
                invaders.forEach(invader => {
                    invader.direction *= -1;
                    invader.y += 20;
                });
            }
            
            // Aggiorna e disegna gli invasori
            for (let i = invaders.length - 1; i >= 0; i--) {
                invaders[i].update();
                invaders[i].draw();
                
                // Game over se un invasore raggiunge il basso
                if (invaders[i].y + invaders[i].height > player.y) {
                    lives = 0;
                    gameOver = true;
                }
            }
            
            // Disegna le barriere
            barriers.forEach(barrier => {
                barrier.draw();
            });
            
            // Aggiorna e disegna gli effetti di esplosione
            for (let i = explosions.length - 1; i >= 0; i--) {
                if (!explosions[i].update()) {
                    explosions.splice(i, 1);
                } else {
                    explosions[i].draw();
                }
            }
            
            // Controlla le collisioni
            checkCollisions();
            
            // Disegna UI
            drawUI();
            
            // Controlla condizioni di vittoria
            if (invaders.length === 0) {
                level++;
                spawnInvaders();
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Controllo delle collisioni
        function checkCollisions() {
            // Proiettili giocatore vs UFO
            if (ufo) {
                for (let i = playerBullets.length - 1; i >= 0; i--) {
                    if (
                        playerBullets[i].x < ufo.x + ufo.width &&
                        playerBullets[i].x + playerBullets[i].width > ufo.x &&
                        playerBullets[i].y < ufo.y + ufo.height &&
                        playerBullets[i].y + playerBullets[i].height > ufo.y
                    ) {
                        // Aggiungi esplosione
                        explosions.push(new Explosion(ufo.x, ufo.y, '#FF0000'));
                        
                        // Aumenta il punteggio
                        score += ufo.points;
                        
                        // Rimuovi UFO e proiettile
                        ufo = null;
                        playerBullets.splice(i, 1);
                        break;
                    }
                }
            }
            
            // Proiettili giocatore vs invasori
            for (let i = playerBullets.length - 1; i >= 0; i--) {
                for (let j = invaders.length - 1; j >= 0; j--) {
                    if (
                        playerBullets[i].x < invaders[j].x + invaders[j].width &&
                        playerBullets[i].x + playerBullets[i].width > invaders[j].x &&
                        playerBullets[i].y < invaders[j].y + invaders[j].height &&
                        playerBullets[i].y + playerBullets[i].height > invaders[j].y
                    ) {
                        // Esplosione dell'alieno
                        explosions.push(new Explosion(invaders[j].x, invaders[j].y));
                        
                        // Punteggio in base al tipo di invasore
                        let points = 10;
                        if (invaders[j].type === 0) points = 30;
                        else if (invaders[j].type === 1) points = 20;
                        else points = 10;
                        
                        score += points;
                        
                        // Rimuovi invasore e proiettile
                        invaders.splice(j, 1);
                        playerBullets.splice(i, 1);
                        break;
                    }
                }
            }
            
            // Proiettili alieni vs giocatore
            for (let i = alienBullets.length - 1; i >= 0; i--) {
                if (
                    alienBullets[i].x < player.x + player.width &&
                    alienBullets[i].x + alienBullets[i].width > player.x &&
                    alienBullets[i].y < player.y + player.height &&
                    alienBullets[i].y + alienBullets[i].height > player.y
                ) {
                    // Esplosione del giocatore
                    explosions.push(new Explosion(player.x, player.y, '#00FF00'));
                    
                    lives--;
                    alienBullets.splice(i, 1);
                    
                    if (lives <= 0) {
                        gameOver = true;
                    }
                    
                    break;
                }
            }
            
            // Proiettili vs barriere
            for (let i = playerBullets.length - 1; i >= 0; i--) {
                for (let j = barriers.length - 1; j >= 0; j--) {
                    if (
                        playerBullets[i].x < barriers[j].x + barriers[j].width &&
                        playerBullets[i].x + playerBullets[i].width > barriers[j].x &&
                        playerBullets[i].y < barriers[j].y + barriers[j].height &&
                        playerBullets[i].y + playerBullets[i].height > barriers[j].y
                    ) {
                        const destroyed = barriers[j].addDamage(playerBullets[i].x, playerBullets[i].y);
                        if (destroyed) {
                            barriers.splice(j, 1);
                        }
                        playerBullets.splice(i, 1);
                        break;
                    }
                }
            }
            
            for (let i = alienBullets.length - 1; i >= 0; i--) {
                for (let j = barriers.length - 1; j >= 0; j--) {
                    if (
                        alienBullets[i].x < barriers[j].x + barriers[j].width &&
                        alienBullets[i].x + alienBullets[i].width > barriers[j].x &&
                        alienBullets[i].y < barriers[j].y + barriers[j].height &&
                        alienBullets[i].y + alienBullets[i].height > barriers[j].y
                    ) {
                        const destroyed = barriers[j].addDamage(alienBullets[i].x, alienBullets[i].y);
                        if (destroyed) {
                            barriers.splice(j,